#!/usr/bin/env rua
-- see how well I can run langfix in the parent and the child
local Lua = require 'lua'
local lua = Lua()


lua.load = |:, data, source| do

	-- here we have to redirect the luaL_loadbuffer to first convert langfix-lua to normal lua
	-- (copied from langfix/env.lua's langfix.loadstate.xforms:
	-- NOTICE THIS IS ALREADY LOADED INTO THE PARENT STATE
	-- it'd be nice if I could just access the function...
	-- like `return require 'langfix.env'().luaToFixed(data)`
	local LuaFixedParser = require 'langfix.parser'
	local parser = LuaFixedParser()
	assert(parser:setData(data, source))
	local result = parser.tree:toLua{maintainSpan=true}

	return Lua.load(self, result, source)
end

-- make sure langfix works in parent ...
local f = ||do
	local g = lua[[
-- make sure langfix works in child ...
local g = ||do
	return "hello from langfix lua child State"
end
return g
]]

	return g()
end
assert.eq(f(), "hello from langfix lua child State")
